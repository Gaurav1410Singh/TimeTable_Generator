<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modify Lesson Details</title>
  <link rel="stylesheet" href="css/StyleHomePage.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    .modify-lesson-form {
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      background: #f4f4f4;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h3 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
        display: inherit;
        /* flex-direction: column;
        align-items: flex-start; */
        margin-bottom: 20px;
      }

      label {
        margin-bottom: 5px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

    button {
      padding: 10px 15px;
      background-color: #004aad;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #003a8c;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
    }

    th {
      background-color: #004aad;
      color: white;
    }

    .action-buttons button {
      margin-right: 5px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 50%;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

  </style>
</head>
<body>

  <div class="modify-lesson-form">
    <h3>Add New Lesson</h3>
    <div class="form-group">
      <label for="subject">Subject:</label>
      <input type="text" id="subject" placeholder="Enter Subject Name">
    </div>
    <div class="form-group">
      <label for="lecturesPerWeek">Lectures per Week:</label>
      <input type="number" id="lecturesPerWeek" min="1" placeholder="Enter Lectures per Week">
    </div>
    <div class="form-group">
        <label for="isPractical">Practical Lesson:</label>
        <input type="checkbox" id="isPractical">
    </div>
    <div class="form-group">
      <label for="primaryTeacher">Primary Teacher:</label>
      <select id="primaryTeacher"></select>
    </div>
    <div class="form-group">
      <label for="studentGroup">Student Group:</label>
      <input type="text" id="studentGroup" placeholder="Enter Student Group">
    </div>
    <button id="saveLessonButton">Save Lesson</button>
  </div>

  <table>
    <thead>
      <tr>
        <!-- <th>Id</th> -->
        <th>Subject</th>
        <th>Lectures/Week</th>
        <th>Practical</th>
        <th>Primary Teacher</th>
        <th>Student Group</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="lessonTableBody">
    </tbody>
  </table>

  <!-- Update Lesson Modal -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="modal" id="updateModal">
    <h3>Update Lesson</h3>
    <div class="form-group">
      <label for="updateSubject">Subject:</label>
      <input type="text" id="updateSubject">
    </div>
    <!-- <div class="form-group">
      <label for="updateLecturesPerWeek">Lectures per Week:</label>
      <input type="number" id="updateLecturesPerWeek">
    </div> -->
    <div class="form-group">
      <label for="updateIsPractical">Practical Lesson:</label>
      <input type="checkbox" id="updateIsPractical">
    </div>
    <div class="form-group">
      <label for="updatePrimaryTeacher">Primary Teacher:</label>
      <select id="updatePrimaryTeacher"></select>
    </div>
    <div class="form-group">
      <label for="updateStudentGroup">Student Group:</label>
      <input type="text" id="updateStudentGroup">
    </div>
    <button id="saveUpdateButton">Update Lesson</button>
  </div>

  <script>
    const lessonApiUrl = "http://localhost:8080/timetable/lessons";
    const teacherApiUrl = "http://localhost:8080/timetable/teachers";
    let currentLessonId = null;
    let currentLessonLecturePerWeek = null;

    async function loadTeachers(selectId) {
      const response = await fetch(teacherApiUrl);
      const teachers = await response.json();
      const teacherSelect = document.getElementById(selectId);
      teacherSelect.innerHTML = "<option value=''>Select a Teacher</option>";
      teachers.forEach(teacher => {
        const option = document.createElement("option");
        option.value = teacher.id;
        option.textContent = teacher.name;
        teacherSelect.appendChild(option);
      });
    }

    async function loadLessons() {
      const response = await fetch(lessonApiUrl);
      const lessons = await response.json();
      const lessonTableBody = document.getElementById("lessonTableBody");
      lessonTableBody.innerHTML = "";
      lessons.forEach(lesson => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${lesson.subject}</td>
          <td>${lesson.lecturesPerWeek}</td>
          <td>${lesson.practical ? "Yes" : "No"}</td>
          <td>${lesson.primaryTeacher ? lesson.primaryTeacher.name : "N/A"}</td>
          <td>${lesson.studentGroup}</td>
          <td class="action-buttons">
            <button onclick="deleteLesson(${lesson.id})">Delete</button>
            <button onclick="openUpdateModal(${lesson.id})">Update</button>
          </td>
        `;
        lessonTableBody.appendChild(row);
      });
    }

    async function openUpdateModal(lessonId) {
      const response = await fetch(`${lessonApiUrl}/${lessonId}`);
      const lesson = await response.json();
      document.getElementById("updateSubject").value = lesson.subject;
      // document.getElementById("updateLecturesPerWeek").value = lesson.lecturesPerWeek;
      document.getElementById("updateIsPractical").checked = lesson.isPractical;
      document.getElementById("updateStudentGroup").value = lesson.studentGroup;
      currentLessonId = lessonId;
      currentLessonLecturePerWeek = lesson.lecturesPerWeek;
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById("updateModal").style.display = "block";
    }

    //saving logic
    document.getElementById("saveLessonButton").addEventListener("click", async () => {
      if(document.getElementById("primaryTeacher").value == null) return;
      const lesson = {
        subject: document.getElementById("subject").value,
        lecturesPerWeek: document.getElementById("lecturesPerWeek").value,
        primaryTeacher: {
        id: parseInt(document.getElementById("primaryTeacher").value, 10) // Convert string to number
    },
        practical: document.getElementById("isPractical").checked,
        studentGroup: document.getElementById("studentGroup").value,
      };

      const response = await fetch(`${lessonApiUrl}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lesson),
      });

      if (response.ok) {
        alert("Lesson saved successfully!");
        loadLessons();
      }
      
    });

    //updation logic
    document.getElementById("saveUpdateButton").addEventListener("click", async () => {
      const updatedLesson = {
        id:currentLessonId,
        subject: document.getElementById("updateSubject").value,
        lecturesPerWeek: currentLessonLecturePerWeek,
        primaryTeacher: {
        id: parseInt(document.getElementById("updatePrimaryTeacher").value, 10) // Convert string to number
    },
        practical: document.getElementById("updateIsPractical").checked,
        studentGroup: document.getElementById("updateStudentGroup").value,
      };

      const response = await fetch(`${lessonApiUrl}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedLesson),
      });

      if (response.ok) {
        alert("Lesson updated successfully!");
        document.getElementById("modalOverlay").style.display = "none";
        document.getElementById("updateModal").style.display = "none";
        loadLessons();
      }
      
    });

    // Delete lesson
    async function deleteLesson(lessonId) {
      const response = await fetch(`${lessonApiUrl}/${lessonId}`, { method: "DELETE" });

      if (response.ok) {
        alert("Lesson deleted successfully!");
        loadLessons();
      }
    }

    loadTeachers("primaryTeacher");
    loadTeachers("updatePrimaryTeacher");
    loadLessons();
  </script>

</body>
</html>
